@model WebZootecPro.ViewModels.Produccion.RegistrarProduccionViewModel

@{
    ViewData["Title"] = "Registrar producción de leche";
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Registrar" method="post">

    <div class="mb-3">
        <label asp-for="IdAnimal" class="form-label"></label>
        <select asp-for="IdAnimal" class="form-select" asp-items="ViewBag.IdAnimal"></select>
        <span asp-validation-for="IdAnimal" class="text-danger"></span>
    </div>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="FechaOrdeno" class="form-label"></label>
            <input asp-for="FechaOrdeno" class="form-control" type="date" />
            <span asp-validation-for="FechaOrdeno" class="text-danger"></span>
        </div>

        <div class="col-md-4 mb-3">
            <label asp-for="Turno" class="form-label"></label>
            <select id="turno" asp-for="Turno" class="form-select">
                <option value="MAÑANA">Mañana</option>
                <option value="TARDE">Tarde</option>
                <option value="NOCHE">Noche</option>
            </select>
            <span asp-validation-for="Turno" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="Fuente" class="form-label"></label>
            <select asp-for="Fuente" class="form-select" asp-items="ViewBag.Fuentes">
                <option value="">-- Seleccione --</option>
            </select>
            <span asp-validation-for="Fuente" class="text-danger"></span>
        </div>


        <div class="col-md-4 mb-3">
            <label asp-for="DiasEnLeche" class="form-label"></label>
            <input asp-for="DiasEnLeche" class="form-control" readonly />
        </div>
    </div>

    <hr />

    <h5>Fases del ordeño (horas)</h5>
    <div class="row">
        <div class="col-md-2 mb-3">
            <label asp-for="HoraPreparacion" class="form-label"></label>
            <input id="horaPreparacion" asp-for="HoraPreparacion" class="form-control" type="time" />
            <span asp-validation-for="HoraPreparacion" class="text-danger"></span>
        </div>

        <div class="col-md-2 mb-3">
            <label asp-for="HoraLimpieza" class="form-label"></label>
            <input id="horaLimpieza" asp-for="HoraLimpieza" class="form-control" type="time" />
            <span asp-validation-for="HoraLimpieza" class="text-danger"></span>
        </div>

        <div class="col-md-2 mb-3">
            <label asp-for="HoraDespunte" class="form-label"></label>
            <input id="horaDespunte" asp-for="HoraDespunte" class="form-control" type="time" />
            <span asp-validation-for="HoraDespunte" class="text-danger"></span>
        </div>

        <div class="col-md-2 mb-3">
            <label asp-for="HoraColocacionPezoneras" class="form-label"></label>
            <input id="horaColocacion" asp-for="HoraColocacionPezoneras" class="form-control" type="time" />
            <span asp-validation-for="HoraColocacionPezoneras" class="text-danger"></span>
        </div>

        <div class="col-md-2 mb-3">
            <label asp-for="HoraInicio" class="form-label"></label>
            <input id="horaInicio" asp-for="HoraInicio" class="form-control" type="time" />
            <span asp-validation-for="HoraInicio" class="text-danger"></span>
        </div>

        <div class="col-md-2 mb-3">
            <label asp-for="HoraFin" class="form-label"></label>
            <input id="horaFin" asp-for="HoraFin" class="form-control" type="time" />
            <span asp-validation-for="HoraFin" class="text-danger"></span>
        </div>
    </div>

    <hr />

    <div class="row">
        <div class="col-md-3 mb-3">
            <label asp-for="CantidadTotal" class="form-label"></label>
            <input id="cantidadTotal" asp-for="CantidadTotal" class="form-control text-dark" readonly />
            <span asp-validation-for="CantidadTotal" class="text-danger"></span>
        </div>

        <div class="col-md-3 mb-3">
            <label asp-for="CantidadIndustria" class="form-label"></label>
            <input id="cantidadIndustria" asp-for="CantidadIndustria" class="form-control" />
        </div>

        <div class="col-md-3 mb-3">
            <label asp-for="CantidadTerneros" class="form-label"></label>
            <input id="cantidadTerneros" asp-for="CantidadTerneros" class="form-control" />
        </div>

        <div class="col-md-3 mb-3">
            <label asp-for="CantidadDescartada" class="form-label"></label>
            <input id="cantidadDescartada" asp-for="CantidadDescartada" class="form-control" />
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="CantidadVentaDirecta" class="form-label"></label>
        <input id="cantidadVentaDirecta" asp-for="CantidadVentaDirecta" class="form-control" />
    </div>

    <div class="form-check mb-3">
        <input asp-for="TieneAntibiotico" class="form-check-input" />
        <label asp-for="TieneAntibiotico" class="form-check-label"></label>
    </div>

    <div class="mb-3">
        <label asp-for="MotivoDescarte" class="form-label"></label>
        <input asp-for="MotivoDescarte" class="form-control" />
    </div>

    <!--calidad-->
    @if (User.IsInRole("SUPERADMIN") || User.IsInRole("ADMIN_EMPRESA") || User.IsInRole("LABORATORIO_EMPRESA"))
    {
        <hr />
        <h5>Calidad de leche (opcional)</h5>

        <div class="row">
            <div class="col-md-2 mb-3">
                <label asp-for="Grasa" class="form-label"></label>
                <input type="number" min="0" max="100" asp-for="Grasa" class="form-control" />
            </div>

            <div class="col-md-2 mb-3">
                <label asp-for="Proteina" class="form-label"></label>
                <input type="number" min="0" max="100" asp-for="Proteina" class="form-control" />
            </div>

            <div class="col-md-3 mb-3">
                <label asp-for="SolidosTotales" class="form-label"></label>
                <input type="number" min="0" max="100" asp-for="SolidosTotales" class="form-control" />
            </div>

            <div class="col-md-2 mb-3">
                <label asp-for="Urea" class="form-label"></label>
                <input asp-for="Urea" class="form-control" />
            </div>

            <div class="col-md-3 mb-3">
                <label asp-for="Rcs" class="form-label"></label>
                <input asp-for="Rcs" class="form-control" />
            </div>
        </div>
    }
    <div id="retiroAlert" class="alert alert-danger d-none">
    </div>
    <button type="submit" class="btn btn-primary mt-2">Guardar</button>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {

          // -------- helpers --------
          function byIdAny() {
            for (let i = 0; i < arguments.length; i++) {
              const el = document.getElementById(arguments[i]);
              if (el) return el;
            }
            return null;
          }

          // Soporta "12.5" y "12,5" y vacío
          function toDec(v) {
            if (v === null || v === undefined) return 0;
            const s = v.toString().trim().replace(",", ".");
            const x = parseFloat(s);
            return isNaN(x) ? 0 : x;
          }

          function pad2(n) {
            const s = n.toString();
            return s.length < 2 ? ("0" + s) : s;
          }

          // -------- turno / validación horas --------
          const turno = byIdAny("turno", "Turno");
          const horaPreparacion = byIdAny("horaPreparacion", "HoraPreparacion");
          const horaLimpieza    = byIdAny("horaLimpieza", "HoraLimpieza");
          const horaDespunte    = byIdAny("horaDespunte", "HoraDespunte");
          const horaColocacion  = byIdAny("horaColocacion", "HoraColocacion");
          const horaInicio      = byIdAny("horaInicio", "HoraInicio");

          function setMinMaxHoras(idxTurno) {
            // idxTurno: 1=mañana, 2=tarde, 3=noche
            const inf = pad2(6 * idxTurno);
            const sup = pad2(6 * (idxTurno + 1));

            const arr = [horaPreparacion, horaLimpieza, horaDespunte, horaColocacion, horaInicio].filter(Boolean);
            arr.forEach(inp => {
              inp.setAttribute("min", inf + ":00");
              inp.setAttribute("max", sup + ":00");
            });
          }

          function turnoToIdx(t) {
            switch (t) {
              case "MAÑANA": return 1;
              case "TARDE":  return 2;
              case "NOCHE":  return 3;
              default:       return 1;
            }
          }

          if (turno) {
            setMinMaxHoras(turnoToIdx(turno.value));
            turno.addEventListener("change", (ev) => {
              setMinMaxHoras(turnoToIdx(ev.target.value));
            });
          }

          // -------- TOTAL (decimales, recalculado) --------
          const inpIndustria = byIdAny("cantidadIndustria", "CantidadIndustria");
          const inpTerneros  = byIdAny("cantidadTerneros", "CantidadTerneros");
          const inpDesc      = byIdAny("cantidadDescartada", "CantidadDescartada");
          const inpVenta     = byIdAny("cantidadVentaDirecta", "CantidadVentaDirecta");
          const inpTotal     = byIdAny("cantidadTotal", "CantidadTotal");

          function updateTotal() {
            if (!inpTotal) return;
            const t = toDec(inpIndustria?.value) + toDec(inpTerneros?.value) + toDec(inpDesc?.value) + toDec(inpVenta?.value);
            inpTotal.value = t.toFixed(2);
          }

          [inpIndustria, inpTerneros, inpDesc, inpVenta].filter(Boolean).forEach(el => {
            el.addEventListener("input", updateTotal);
            el.addEventListener("change", updateTotal);
          });

          updateTotal();

          // -------- DEL + RETIRO (tu lógica, pero llamando updateTotal) --------
          const selAnimal = byIdAny("IdAnimal");
          const inpFecha  = byIdAny("FechaOrdeno");
          const inpDel    = byIdAny("DiasEnLeche");

          const chkAnti   = byIdAny("TieneAntibiotico");
          const inpMotivo = byIdAny("MotivoDescarte");
          const retiroAlert = byIdAny("retiroAlert");

          async function refreshDEL() {
            const id = selAnimal?.value || "";
            const fecha = inpFecha?.value || "";
            if (!id || !fecha) { if (inpDel) inpDel.value = ""; return; }

            const url = '@Url.Action("CalcularDel", "Produccion")'
              + '?idAnimal=' + encodeURIComponent(id)
              + '&fechaOrdeno=' + encodeURIComponent(fecha);

            try {
              const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
              if (!res.ok) return;
              const data = await res.json();
              if (inpDel) inpDel.value = (data.diasEnLeche ?? "");
            } catch { }
          }

          async function refreshRetiro() {
            const id = selAnimal?.value || "";
            const fecha = inpFecha?.value || "";

            if (!id || !fecha) {
              if (retiroAlert) retiroAlert.classList.add("d-none");
              if (inpIndustria) inpIndustria.disabled = false;
              if (inpVenta) inpVenta.disabled = false;
              return;
            }

            const url = '@Url.Action("GetRetiroLeche", "Produccion")'
              + '?idAnimal=' + encodeURIComponent(id)
              + '&fechaOrdeno=' + encodeURIComponent(fecha);

            try {
              const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
              if (!res.ok) return;
              const data = await res.json();

              const enRetiro = !!data.enRetiro;
              const retiroHasta = data.retiroHasta;

              if (!enRetiro) {
                if (retiroAlert) retiroAlert.classList.add("d-none");
                if (inpIndustria) inpIndustria.disabled = false;
                if (inpVenta) inpVenta.disabled = false;
                return;
              }

              if (retiroAlert) {
                retiroAlert.textContent = `⚠️ Animal en RETIRO DE LECHE hasta ${retiroHasta}. No se permite Industria/Venta y se envía a Descarte.`;
                retiroAlert.classList.remove("d-none");
              }

              // mover valores digitados a descarte
              const ind = toDec(inpIndustria?.value);
              const ven = toDec(inpVenta?.value);
              const mov = ind + ven;

              if (inpIndustria) { inpIndustria.value = "0"; inpIndustria.disabled = true; }
              if (inpVenta) { inpVenta.value = "0"; inpVenta.disabled = true; }

              if (inpDesc && mov > 0) {
                inpDesc.value = (toDec(inpDesc.value) + mov).toFixed(2);
              }

              if (chkAnti) chkAnti.checked = true;

              if (inpMotivo && (!inpMotivo.value || inpMotivo.value.trim() === "")) {
                inpMotivo.value = `RETIRO DE LECHE por tratamiento (hasta ${retiroHasta})`;
              }

              updateTotal(); // ✅ importantísimo
            } catch { }
          }

          if (selAnimal) selAnimal.addEventListener("change", () => { refreshDEL(); refreshRetiro(); });
          if (inpFecha)  inpFecha.addEventListener("change", () => { refreshDEL(); refreshRetiro(); });

          refreshDEL();
          refreshRetiro();

        })();
    </script>
}
